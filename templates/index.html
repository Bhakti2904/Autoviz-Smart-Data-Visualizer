{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Header -->
    <header class="gradient-bg text-white py-12 shadow-2xl">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-center space-x-6">
                <div class="bg-white bg-opacity-20 p-6 rounded-3xl backdrop-blur-sm">
                    <i class="fas fa-chart-bar text-4xl"></i>
                </div>
                <div class="text-center">
                    <h1 class="text-5xl md:text-6xl font-bold mb-3 tracking-tight">AutoViz</h1>
                    <p class="text-2xl opacity-90 font-light">Smart Data Visualizer</p>
                    <p class="text-base opacity-75 mt-2 font-medium">Upload ‚Ä¢ Explore ‚Ä¢ Visualize</p>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-8">
                <!-- File Upload -->
                <div class="sidebar-section p-8">
                    <h3 class="text-xl font-bold mb-6 flex items-center text-gray-800">
                        <i class="fas fa-upload mr-3 text-blue-500 text-lg"></i>
                        Upload Data
                    </h3>
                    
                    <div id="upload-area" class="upload-area rounded-2xl p-12 text-center cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-6 animate-bounce-slow"></i>
                        <p class="text-gray-700 mb-3 font-medium text-lg">Drag & drop your file here</p>
                        <p class="text-gray-500 mb-6">or click to browse</p>
                        <input type="file" id="file-input" class="hidden" accept=".csv,.json,.xlsx,.xls">
                        <button id="browse-btn" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold text-lg">
                            <i class="fas fa-folder-open mr-2"></i>
                            Choose File
                        </button>
                        <p class="text-sm text-gray-400 mt-4 font-medium">CSV, JSON, Excel supported</p>
                    </div>
                    
                    <div id="file-info" class="hidden mt-6 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <i class="fas fa-file-alt text-green-600 text-2xl"></i>
                                <div>
                                    <p id="file-name" class="font-bold text-green-800 text-lg"></p>
                                    <p id="file-size" class="text-green-600 font-medium"></p>
                                </div>
                            </div>
                            <button id="remove-file" class="text-red-500 hover:text-red-700 text-xl transition-colors">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chart Configuration -->
                <div id="chart-config" class="hidden sidebar-section p-8">
                    <h3 class="text-xl font-bold mb-6 flex items-center text-gray-800">
                        <i class="fas fa-cog mr-3 text-purple-500 text-lg"></i>
                        Chart Settings
                    </h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">Chart Type</label>
                            <select id="chart-type" class="select-custom w-full p-4 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent font-medium">
                                <option value="bar">üìä Bar Chart</option>
                                <option value="line">üìà Line Chart</option>
                                <option value="scatter">üîµ Scatter Plot</option>
                                <option value="pie">ü•ß Pie Chart</option>
                                <option value="area">üìä Area Chart</option>
                                <option value="histogram">üìä Histogram</option>
                                <option value="box">üì¶ Box Plot</option>
                                <option value="heatmap">üî• Heatmap</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">X-Axis</label>
                            <select id="x-axis" class="select-custom w-full p-4 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent font-medium">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">Y-Axis</label>
                            <select id="y-axis" class="select-custom w-full p-4 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent font-medium">
                                <option value="">Select column...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">Color Scheme</label>
                            <select id="color-scheme" class="select-custom w-full p-4 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent font-medium">
                                <option value="default">üé® Default</option>
                                <option value="viridis">üíú Viridis</option>
                                <option value="plasma">üî• Plasma</option>
                                <option value="blues">üíô Blues</option>
                                <option value="reds">‚ù§Ô∏è Reds</option>
                                <option value="greens">üíö Greens</option>
                                <option value="sunset">üåÖ Sunset</option>
                                <option value="ocean">üåä Ocean</option>
                                <option value="purple">üíú Purple</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">Chart Title</label>
                            <input type="text" id="chart-title" value="My Visualization" class="input-custom w-full p-4 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent font-medium">
                        </div>
                        
                        <button id="generate-chart" class="w-full btn-primary text-white py-4 rounded-xl font-bold text-lg">
                            <i class="fas fa-chart-line mr-2"></i>
                            Generate Chart
                        </button>
                    </div>
                </div>

                <!-- Export Options -->
                <div id="export-options" class="hidden sidebar-section p-8">
                    <h3 class="text-xl font-bold mb-6 flex items-center text-gray-800">
                        <i class="fas fa-download mr-3 text-green-500 text-lg"></i>
                        Export Options
                    </h3>
                    
                    <div class="space-y-4">
                        <button id="export-png" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-6 rounded-xl font-bold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-image mr-2"></i>
                            Download PNG
                        </button>
                        
                        <button id="export-csv" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-6 rounded-xl font-bold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-file-csv mr-2"></i>
                            Download CSV
                        </button>
                        
                        <button id="export-json" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl font-bold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-file-code mr-2"></i>
                            Download JSON
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="lg:col-span-3">
                <!-- Data Stats -->
                <div id="data-stats" class="hidden grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card text-white p-8 text-center">
                        <div class="text-4xl font-bold mb-2" id="total-rows">0</div>
                        <div class="text-lg opacity-90 font-medium">Total Rows</div>
                    </div>
                    <div class="metric-card text-white p-8 text-center">
                        <div class="text-4xl font-bold mb-2" id="total-columns">0</div>
                        <div class="text-lg opacity-90 font-medium">Columns</div>
                    </div>
                    <div class="metric-card text-white p-8 text-center">
                        <div class="text-4xl font-bold mb-2" id="numeric-columns">0</div>
                        <div class="text-lg opacity-90 font-medium">Numeric</div>
                    </div>
                    <div class="metric-card text-white p-8 text-center">
                        <div class="text-4xl font-bold mb-2" id="categorical-columns">0</div>
                        <div class="text-lg opacity-90 font-medium">Categorical</div>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="chart-container p-8">
                    <div id="welcome-screen" class="text-center py-20">
                        <div class="text-8xl mb-8 animate-pulse-slow">üìä</div>
                        <h2 class="text-4xl font-bold text-gray-800 mb-6">Ready to Visualize Your Data</h2>
                        <p class="text-gray-600 text-xl mb-12 max-w-2xl mx-auto leading-relaxed">Upload your CSV, JSON, or Excel file to get started with creating beautiful, interactive visualizations</p>
                        
                        <div class="flex justify-center items-center space-x-12 text-gray-500">
                            <div class="workflow-step flex flex-col items-center space-y-3">
                                <div class="bg-blue-100 p-6 rounded-full">
                                    <i class="fas fa-upload text-3xl text-blue-500"></i>
                                </div>
                                <span class="font-bold text-lg">Upload</span>
                            </div>
                            <div class="w-16 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>
                            <div class="workflow-step flex flex-col items-center space-y-3">
                                <div class="bg-purple-100 p-6 rounded-full">
                                    <i class="fas fa-search text-3xl text-purple-500"></i>
                                </div>
                                <span class="font-bold text-lg">Explore</span>
                            </div>
                            <div class="w-16 h-1 bg-gradient-to-r from-purple-500 to-green-500 rounded-full"></div>
                            <div class="workflow-step flex flex-col items-center space-y-3">
                                <div class="bg-green-100 p-6 rounded-full">
                                    <i class="fas fa-chart-bar text-3xl text-green-500"></i>
                                </div>
                                <span class="font-bold text-lg">Visualize</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chart-container" class="hidden">
                        <div id="plotly-chart"></div>
                    </div>
                </div>

                <!-- Data Preview -->
                <div id="data-preview" class="hidden mt-8 card p-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                        <i class="fas fa-table mr-3 text-indigo-500"></i>
                        Data Preview
                    </h3>
                    <div class="overflow-x-auto">
                        <table id="data-table" class="table-custom w-full text-sm">
                            <thead id="table-header"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class AutoVizApp {
    constructor() {
        this.currentData = null;
        this.currentHeaders = null;
        this.currentChart = null;
        
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        // File upload
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const browseBtn = document.getElementById('browse-btn');
        
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => this.handleFileUpload(e.target.files[0]));
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            this.handleFileUpload(e.dataTransfer.files[0]);
        });
        
        // Remove file
        document.getElementById('remove-file').addEventListener('click', () => {
            this.resetApp();
        });
        
        // Chart generation
        document.getElementById('generate-chart').addEventListener('click', () => {
            this.generateChart();
        });
        
        // Export buttons
        document.getElementById('export-png').addEventListener('click', () => {
            this.exportChart('png');
        });
        
        document.getElementById('export-csv').addEventListener('click', () => {
            this.exportData('csv');
        });
        
        document.getElementById('export-json').addEventListener('click', () => {
            this.exportData('json');
        });
    }
    
    async handleFileUpload(file) {
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        const uploadBtn = document.getElementById('browse-btn');
        const hideLoading = showLoading(uploadBtn);
        
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.currentData = result.data;
                this.currentHeaders = result.headers;
                
                this.showFileInfo(file, result.total_rows);
                this.populateColumnSelectors(result.headers, result.column_info);
                this.showDataStats(result);
                this.showDataPreview(result.data, result.headers);
                
                showNotification('File uploaded successfully! üéâ', 'success');
            } else {
                showNotification(result.error, 'error');
            }
        } catch (error) {
            showNotification('Upload failed: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    showFileInfo(file, totalRows) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = `${(file.size / 1024).toFixed(1)} KB ‚Ä¢ ${totalRows} rows`;
        document.getElementById('file-info').classList.remove('hidden');
        document.getElementById('chart-config').classList.remove('hidden');
        document.getElementById('export-options').classList.remove('hidden');
        
        // Add fade-in animation
        document.getElementById('file-info').classList.add('fade-in');
        document.getElementById('chart-config').classList.add('fade-in');
        document.getElementById('export-options').classList.add('fade-in');
    }
    
    populateColumnSelectors(headers, columnInfo) {
        const xAxisSelect = document.getElementById('x-axis');
        const yAxisSelect = document.getElementById('y-axis');
        
        // Clear existing options
        xAxisSelect.innerHTML = '<option value="">Select column...</option>';
        yAxisSelect.innerHTML = '<option value="">Select column...</option>';
        
        // Populate options
        headers.forEach(header => {
            const xOption = new Option(header, header);
            const yOption = new Option(header, header);
            
            xAxisSelect.appendChild(xOption);
            yAxisSelect.appendChild(yOption);
        });
        
        // Auto-select first two columns
        if (headers.length >= 2) {
            xAxisSelect.value = headers[0];
            yAxisSelect.value = headers[1];
        }
    }
    
    showDataStats(result) {
        document.getElementById('total-rows').textContent = result.total_rows;
        document.getElementById('total-columns').textContent = result.headers.length;
        
        const numericCols = Object.values(result.column_info).filter(col => col.type === 'numeric').length;
        const categoricalCols = Object.values(result.column_info).filter(col => col.type === 'categorical').length;
        
        document.getElementById('numeric-columns').textContent = numericCols;
        document.getElementById('categorical-columns').textContent = categoricalCols;
        document.getElementById('data-stats').classList.remove('hidden');
        document.getElementById('data-stats').classList.add('fade-in');
    }
    
    showDataPreview(data, headers) {
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('table-body');
        
        // Create header
        tableHeader.innerHTML = '<tr>' + 
            headers.map(h => `<th class="px-6 py-4 text-left font-bold text-gray-700 border-b-2 border-gray-200">${h}</th>`).join('') + 
            '</tr>';
        
        // Create rows (first 10)
        tableBody.innerHTML = data.slice(0, 10).map(row => 
            '<tr class="hover:bg-gray-50 transition-colors">' + 
            headers.map(h => `<td class="px-6 py-4 border-b border-gray-200 text-gray-600 font-medium">${row[h] || ''}</td>`).join('') + 
            '</tr>'
        ).join('');
        
        document.getElementById('data-preview').classList.remove('hidden');
        document.getElementById('data-preview').classList.add('fade-in');
        document.getElementById('welcome-screen').classList.add('hidden');
    }
    
    async generateChart() {
        const config = {
            chart_type: document.getElementById('chart-type').value,
            x_axis: document.getElementById('x-axis').value,
            y_axis: document.getElementById('y-axis').value,
            color_scheme: document.getElementById('color-scheme').value,
            title: document.getElementById('chart-title').value
        };
        
        if (!config.x_axis) {
            showNotification('Please select X-axis column', 'error');
            return;
        }
        
        const generateBtn = document.getElementById('generate-chart');
        const hideLoading = showLoading(generateBtn);
        
        try {
            const response = await fetch('/generate_chart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.currentChart = JSON.parse(result.chart);
                
                Plotly.newPlot('plotly-chart', this.currentChart.data, this.currentChart.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false
                });
                
                document.getElementById('chart-container').classList.remove('hidden');
                document.getElementById('chart-container').classList.add('fade-in');
                document.getElementById('welcome-screen').classList.add('hidden');
                
                showNotification('Chart generated successfully! üìä', 'success');
            } else {
                showNotification(result.error, 'error');
            }
        } catch (error) {
            showNotification('Chart generation failed: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    exportChart(format) {
        if (!this.currentChart) {
            showNotification('No chart to export', 'error');
            return;
        }
        
        if (format === 'png') {
            Plotly.downloadImage('plotly-chart', {
                format: 'png',
                width: 1200,
                height: 800,
                filename: document.getElementById('chart-title').value || 'chart'
            });
            showNotification('Chart exported as PNG! üì∏', 'success');
        }
    }
    
    async exportData(format) {
        if (!this.currentData) {
            showNotification('No data to export', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/export_data/${format}`);
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `autoviz_data.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification(`Data exported as ${format.toUpperCase()}! üíæ`, 'success');
            } else {
                showNotification('Export failed', 'error');
            }
        } catch (error) {
            showNotification('Export failed: ' + error.message, 'error');
        }
    }
    
    resetApp() {
        this.currentData = null;
        this.currentHeaders = null;
        this.currentChart = null;
        
        document.getElementById('file-info').classList.add('hidden');
        document.getElementById('chart-config').classList.add('hidden');
        document.getElementById('export-options').classList.add('hidden');
        document.getElementById('data-stats').classList.add('hidden');
        document.getElementById('data-preview').classList.add('hidden');
        document.getElementById('chart-container').classList.add('hidden');
        document.getElementById('welcome-screen').classList.remove('hidden');
        
        document.getElementById('file-input').value = '';
        
        showNotification('App reset successfully! üîÑ', 'info');
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new AutoVizApp();
});
</script>
{% endblock %}
